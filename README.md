<div align="center">

# Kafitra Lynx Native

**Production-ready native modules for [Lynx](https://lynxjs.org/) cross-platform framework.**

[![npm](https://img.shields.io/npm/v/@kafitra/lynx-device-info?label=%40kafitra%2Flynx-device-info&color=blue)](https://www.npmjs.com/package/@kafitra/lynx-device-info) [![npm](https://img.shields.io/npm/v/@kafitra/lynx-storage?label=%40kafitra%2Flynx-storage&color=orange)](https://www.npmjs.com/package/@kafitra/lynx-storage) [![npm](https://img.shields.io/npm/v/@kafitra/lynx-async-storage?label=%40kafitra%2Flynx-async-storage&color=yellow)](https://www.npmjs.com/package/@kafitra/lynx-async-storage) [![npm](https://img.shields.io/npm/v/@kafitra/lynx-camera?label=%40kafitra%2Flynx-camera&color=red)](https://www.npmjs.com/package/@kafitra/lynx-camera) [![npm](https://img.shields.io/npm/v/@kafitra/lynx-cli?label=%40kafitra%2Flynx-cli&color=purple)](https://www.npmjs.com/package/@kafitra/lynx-cli) [![License: MIT](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/Platform-Android%20%7C%20iOS-brightgreen.svg)]()

</div>

---

## Packages

<table>
  <thead>
    <tr>
      <th>Package</th>
      <th>Version</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="./packages/lynx-device-info"><code>@kafitra/lynx-device-info</code></a></td>
      <td><code>0.2.1</code></td>
      <td>Access device brand, model, SDK version, manufacturer, system info, and more</td>
    </tr>
    <tr>
      <td><a href="./packages/lynx-storage"><code>@kafitra/lynx-storage</code></a></td>
      <td><code>0.1.0</code></td>
      <td>Persistent key-value storage — Android SharedPreferences + iOS NSUserDefaults</td>
    </tr>
    <tr>
      <td><a href="./packages/lynx-async-storage"><code>@kafitra/lynx-async-storage</code></a></td>
      <td><code>0.1.0</code></td>
      <td>Promise-based async storage API — mirrors React Native AsyncStorage, wraps lynx-storage</td>
    </tr>
    <tr>
      <td><a href="./packages/lynx-camera"><code>@kafitra/lynx-camera</code></a></td>
      <td><code>0.1.2</code></td>
      <td>Native camera preview and capture UI component — CameraX (Android) + AVFoundation (iOS)</td>
    </tr>
    <tr>
      <td><a href="./packages/lynx-autolink"><code>@kafitra/lynx-autolink</code></a></td>
      <td><code>0.1.1</code></td>
      <td>Auto-linking library — scanner, Java registry generator, Gradle injector, manifest permissions</td>
    </tr>
    <tr>
      <td><a href="./packages/lynx-cli"><code>@kafitra/lynx-cli</code></a></td>
      <td><code>0.2.2</code></td>
      <td>CLI companion — <code>link</code>, <code>run android</code>, <code>prebuild</code>, <code>dev</code>, <code>doctor</code></td>
    </tr>
  </tbody>
</table>

## Monorepo Structure

```
kafitra-lynx-native/
├── packages/                    # Native module libraries
│   ├── lynx-device-info/        # Device info module
│   │   ├── src/                 # TypeScript source
│   │   ├── android/             # Android native implementation
│   │   ├── ios/                 # iOS native implementation
│   │   ├── lynx.module.json     # Auto-link metadata
│   │   └── dist/                # Compiled output
│   ├── lynx-storage/            # Persistent key-value storage (native)
│   │   ├── src/                 # TypeScript source
│   │   ├── android/             # Android SharedPreferences implementation
│   │   ├── ios/                 # iOS NSUserDefaults implementation
│   │   ├── lynx.module.json     # Auto-link metadata
│   │   └── dist/                # Compiled output
│   ├── lynx-async-storage/      # Promise-based async storage (pure JS)
│   │   ├── src/                 # TypeScript source + tests
│   │   └── dist/                # Compiled output (ESM + CJS)
│   ├── lynx-camera/             # Native camera UI component
│   │   ├── src/                 # TypeScript component + types
│   │   ├── android/             # Android CameraX implementation
│   │   ├── ios/                 # iOS AVFoundation implementation
│   │   ├── lynx.module.json     # Auto-link metadata
│   │   └── dist/                # Compiled output
│   ├── lynx-autolink/           # Auto-linking core library
│   │   └── src/                 # scanner, generator, injectors, manifest
│   └── lynx-cli/                # CLI (lynx link, run, prebuild, dev, doctor)
│       └── src/
├── apps/                        # Example & demo applications
│   └── demo2/                   # Demo app — camera, device info, persistent login
│       ├── src/                 # App source (App.tsx, pages/)
│       └── android/             # Android host app (generated by lynx prebuild)
└── package.json                 # Root workspace config
```

## Quick Start

### Prerequisites

- **Node.js** >= 18
- **pnpm** >= 8
- **Android Studio** (for native module development)
- **JDK 17+**

### Installation

```bash
# Clone the repository
git clone https://github.com/kafitramarna/kafitra-lynx-native.git
cd kafitra-lynx-native

# Install dependencies
pnpm install

# Build all packages
pnpm run build
```

### Run Demo App

```bash
cd apps/demo2

# First time — generate Android project
npx @kafitra/lynx-cli prebuild --package com.kafitra.demo2

# Connect a device or start an emulator, then:
npx @kafitra/lynx-cli run android
# → installs APK + opens a new terminal with the dev server (hot reload active)
```

> **The demo app** (`apps/demo2`) showcases `@kafitra/lynx-camera` (live preview, photo capture, torch, flip camera), `@kafitra/lynx-device-info` (device info card), and `@kafitra/lynx-async-storage` (persistent login session that survives app restarts via `@kafitra/lynx-storage`).

> **Hot reload** works out-of-the-box via ETag polling: `MainActivity` polls the bundle URL every 1.5 s and calls `renderTemplateUrl` whenever rspeedy rebuilds.

## Using @kafitra/lynx-camera

### Install

```bash
npm install @kafitra/lynx-camera
# or
pnpm add @kafitra/lynx-camera
```

### Android Setup

Your `Activity` must extend `AppCompatActivity` (required by CameraX):

```java
import androidx.appcompat.app.AppCompatActivity;

public class MainActivity extends AppCompatActivity { ... }
```

Add to `app/build.gradle`:

```groovy
implementation 'androidx.appcompat:appcompat:1.6.1'
```

If using `@kafitra/lynx-autolink` (>= 0.1.1), run `npx @kafitra/lynx-cli link` — the `CAMERA` permission is injected into `AndroidManifest.xml` automatically. Otherwise add it manually:

```xml
<uses-permission android:name="android.permission.CAMERA" />
```

Register the UI component in your `Activity`:

```java
LynxAutolinkRegistry.registerAll();             // native modules
LynxAutolinkRegistry.addUIBehaviorsTo(builder); // native UI elements (camera)
```

> The OS permission dialog is shown **automatically** when `<CameraView>` is first rendered — no manual `requestPermissions` call needed.

### Usage

```tsx
import { CameraView, type CameraRef } from "@kafitra/lynx-camera";
import { useRef } from "@lynx-js/react";

export function CameraScreen() {
  const cam = useRef<CameraRef>(null);

  return (
    <CameraView
      ref={cam}
      device="back"
      flashMode="auto"
      focusMode="continuous"
      zoom={1}
      onCameraReady={() => console.log("ready")}
      onError={(e) => console.error(e.detail.code, e.detail.message)}
      onZoomChanged={(e) => console.log(e.detail.zoom)}
      onPhotoCaptured={(e) => console.log("saved to", e.detail.uri)}
    />
  );
}

// Imperative API
const photo = await cam.current?.takePhoto();
await cam.current?.switchCamera();
await cam.current?.setFlash({ mode: "torch" });
await cam.current?.setZoom({ level: 2.0 });
await cam.current?.focus({ x: 0.5, y: 0.5 });
```

### Props

| Prop        | Type                           | Default        | Description                            |
| ----------- | ------------------------------ | -------------- | -------------------------------------- |
| `device`    | `"front"\|"back"`              | `"back"`       | Which camera to use                    |
| `flashMode` | `"auto"\|"on"\|"off"\|"torch"` | `"auto"`       | Flash / torch mode                     |
| `focusMode` | `"auto"\|"tap"\|"continuous"`  | `"continuous"` | Autofocus strategy                     |
| `zoom`      | `number`                       | `1`            | Zoom ratio (clamped to device min/max) |

### Events

| Event             | Payload                      | Description                                              |
| ----------------- | ---------------------------- | -------------------------------------------------------- |
| `onCameraReady`   | —                            | Camera session started and preview is live               |
| `onError`         | `{ code, message }`          | Camera error (e.g. `PERMISSION_DENIED`, `SESSION_ERROR`) |
| `onZoomChanged`   | `{ zoom, minZoom, maxZoom }` | Fired when zoom changes                                  |
| `onTapFocus`      | `{ x, y }`                   | Fired when user taps to focus (focusMode=`"tap"`)        |
| `onPhotoCaptured` | `{ uri, width, height }`     | Fired after `takePhoto()` completes                      |

---

## Using @kafitra/lynx-storage

### Install

```bash
npm install @kafitra/lynx-storage
# or
pnpm add @kafitra/lynx-storage
```

### Android Setup (Auto-linking)

```bash
npx @kafitra/lynx-cli link
```

Then in your `Application` class:

```java
LynxEnv.inst().init(this, null, null, null);
LynxAutolinkRegistry.registerAll();
```

### Usage

```ts
import { LynxStorage } from "@kafitra/lynx-storage";

LynxStorage.setString("token", "abc123");
const value = LynxStorage.getString("token"); // 'abc123'
LynxStorage.remove("token");
```

> **Tip:** For a Promise-based API, use `@kafitra/lynx-async-storage` alongside — it auto-detects `LynxStorage` as its backend.

## Using @kafitra/lynx-async-storage

### Install

```bash
npm install @kafitra/lynx-async-storage
# For persistent storage, also install:
npm install @kafitra/lynx-storage
```

### Usage

```ts
import AsyncStorage from "@kafitra/lynx-async-storage";

await AsyncStorage.setItem("session", JSON.stringify({ user: "demo" }));
const raw = await AsyncStorage.getItem("session");
const session = raw ? JSON.parse(raw) : null;

await AsyncStorage.removeItem("session");
await AsyncStorage.clear();

// Batch operations
await AsyncStorage.multiSet([
  ["a", "1"],
  ["b", "2"],
]);
const results = await AsyncStorage.multiGet(["a", "b"]);
```

Backend is auto-detected: `NativeModules.LynxStorage` (disk) → `localStorage` → in-memory fallback.

## Using @kafitra/lynx-device-info

### Install

```bash
npm install @kafitra/lynx-device-info
# or
pnpm add @kafitra/lynx-device-info
```

### Android Setup (Auto-linking)

Run the CLI to generate the Java registry and inject Gradle wiring:

```bash
npx @kafitra/lynx-cli link
```

Then in your `Application` class — one line:

```java
// In your Application's initLynxEnv():
LynxEnv.inst().init(this, null, null, null);
LynxAutolinkRegistry.registerAll();
```

> See the [Auto-linking](#auto-linking) section below for full details.

### Usage

```tsx
import { getBrand, getModel, getSDKVersion } from "@kafitra/lynx-device-info";

const brand = await getBrand(); // "Samsung"
const model = await getModel(); // "Galaxy S24"
const sdk = await getSDKVersion(); // 34
```

## Next Development

Here is the list of planned native modules for future development:

<table>
  <thead>
    <tr>
      <th>Module</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>@kafitra/lynx-battery</code></td>
      <td>Battery level, charging status, battery health</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-network</code></td>
      <td>Network type (WiFi/cellular), connection strength, IP address</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-app-info</code></td>
      <td>App version, package name, first install time, build number</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-clipboard</code></td>
      <td>Read, write system clipboard</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-file-system</code></td>
      <td>Read, write, delete files on device storage</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-vibration</code></td>
      <td>Haptic feedback and vibration patterns</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-screen</code></td>
      <td>Screen dimensions, orientation, brightness control</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-notifications</code></td>
      <td>Local push notifications</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-permissions</code></td>
      <td>Runtime permission management</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-share</code></td>
      <td>Native share dialog (text, files, URLs)</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-biometrics</code></td>
      <td>Fingerprint and face authentication</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-sensors</code></td>
      <td>Accelerometer, gyroscope, proximity sensor</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-camera-advanced</code></td>
      <td>Barcode/QR scanning, face detection, video recording</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-geolocation</code></td>
      <td>GPS location access</td>
    </tr>
  </tbody>
</table>

### Future Considerations

- **iOS Support** — Extend all modules with Swift/ObjC native implementations
- **HarmonyOS Support** — Add ArkTS implementations for Huawei ecosystem
- **Gradle Plugin** — Gradle plugin variant of auto-linking for zero-config build integration
- **Testing Framework** — Shared mock utilities for unit testing native modules

## Auto-linking

Starting with **v0.1.0**, all Kafitra Lynx Native Modules support automatic linking — no manual `registerModule` calls needed.

### How it works

1. Each package ships a `lynx.module.json` metadata file at its root.
2. `@kafitra/lynx-autolink` scans `node_modules` for these files.
3. `@kafitra/lynx-cli link` orchestrates the full process in one command.

### Usage

```bash
# 1. Install a Lynx Native Module
npm install @kafitra/lynx-device-info

# 2. Run the linker (from your Android project root)
npx @kafitra/lynx-cli link

# With a custom android directory name:
npx @kafitra/lynx-cli link --android-dir android-host

# With an explicit Java package (if applicationId can't be inferred):
npx @kafitra/lynx-cli link --java-package com.example.myapp
```

### What `lynx link` does

| Step | Action                                                                              |
| ---- | ----------------------------------------------------------------------------------- |
| 1    | Scans `node_modules` (including hoisted monorepo locations) for `lynx.module.json`  |
| 2    | Generates `android/app/src/main/java/<pkg>/LynxAutolinkRegistry.java`               |
| 3    | Injects `include ':module-name'` entries into `android/settings.gradle`             |
| 4    | Injects `implementation project(':module-name')` into `android/app/build.gradle`    |
| 5    | Injects `<uses-permission>` entries into `android/app/src/main/AndroidManifest.xml` |

### Example output

```
→  Scanning for Lynx Native Modules…
ℹ  Found 2 module(s):
ℹ    • @kafitra/lynx-device-info  (LynxDeviceInfo)
ℹ    • @kafitra/lynx-camera       (LynxCamera)

→  Generating LynxAutolinkRegistry.java…
✔  Generated: android/app/src/main/java/com/example/app/LynxAutolinkRegistry.java
→  Injecting settings.gradle entries…
✔  Updated: android/settings.gradle
→  Injecting app/build.gradle dependencies…
✔  Updated: android/app/build.gradle
→  Injecting AndroidManifest.xml permissions…
✔  Updated: android/app/src/main/AndroidManifest.xml  [perms: android.permission.CAMERA]

✔ Linking complete

ℹ  In your Activity, call:
ℹ    LynxAutolinkRegistry.registerAll();
ℹ    LynxAutolinkRegistry.addUIBehaviorsTo(builder); // for native UI components
```

### Metadata file (`lynx.module.json`)

Place this file at the **root** of each native module package (next to `package.json`):

```json
{
  "name": "LynxDeviceInfo",
  "android": {
    "moduleClass": "com.kafitra.lynxdeviceinfo.LynxDeviceInfoModule",
    "sourceDir": "android"
  }
}
```

| Field                       | Required                 | Description                                                                   |
| --------------------------- | ------------------------ | ----------------------------------------------------------------------------- |
| `name`                      | ✅                       | Module name as registered with `LynxEnv`                                      |
| `android.moduleClass`       | ✅¹                      | Fully-qualified Java class name of the `LynxModule` implementation            |
| `android.componentClass`    | ✅¹                      | Fully-qualified Java class name of the `LynxUI` custom element                |
| `android.componentTag`      | ✅ when `componentClass` | JSX element tag (e.g. `"camera"`). Required when `componentClass` is present  |
| `android.sourceDir`         | ✅                       | Relative path to the Android library source (e.g. `"android"`)                |
| `android.gradleProjectName` | optional                 | Override Gradle project name (defaults to kebab-cased npm name)               |
| `android.permissions`       | optional                 | Android permissions — auto-injected into `AndroidManifest.xml` by `lynx link` |

> ¹ At least one of `moduleClass` or `componentClass` must be provided.

### Troubleshooting

| Problem                             | Solution                                                                |
| ----------------------------------- | ----------------------------------------------------------------------- |
| `No Lynx Native Modules found`      | Ensure the package has `lynx.module.json` at its root                   |
| `Could not determine applicationId` | Use `--java-package com.example.app`                                    |
| `build.gradle not found`            | Use `--android-dir` to point to your android folder                     |
| `Malformed lynx.module.json`        | Check for missing `name`, `android.moduleClass`, or `android.sourceDir` |
| Duplicate entries after re-run      | `lynx link` is idempotent — safe to re-run, no duplicates added         |

## Contributing

Contributions are welcome! To add a new native module:

1. Create a new package in `packages/`
2. Follow the structure of `lynx-device-info`
3. Implement TypeScript API + Android native module
4. Add a demo in `apps/demo`
5. Submit a PR

### Development Scripts

```bash
pnpm run build     # Build all packages
pnpm run dev       # Start demo dev server
pnpm run clean     # Clean build artifacts
```

## License

MIT © [Kafitra Marna](https://github.com/kafitramarna)
