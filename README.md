<div align="center">

# Kafitra Lynx Native

**Production-ready native modules for [Lynx](https://lynxjs.org/) cross-platform framework.**

[![npm](https://img.shields.io/npm/v/@kafitra/lynx-device-info?label=%40kafitra%2Flynx-device-info&color=blue)](https://www.npmjs.com/package/@kafitra/lynx-device-info)[![npm](https://img.shields.io/npm/v/@kafitra/lynx-cli?label=%40kafitra%2Flynx-cli&color=purple)](https://www.npmjs.com/package/@kafitra/lynx-cli)[![License: MIT](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/Platform-Android-brightgreen.svg)]()

</div>

---

## Packages

<table>
  <thead>
    <tr>
      <th>Package</th>
      <th>Version</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="./packages/lynx-device-info"><code>@kafitra/lynx-device-info</code></a></td>
      <td><code>0.2.1</code></td>
      <td>Access device brand, model, SDK version, manufacturer, system info, and more</td>
    </tr>
    <tr>
      <td><a href="./packages/lynx-autolink"><code>@kafitra/lynx-autolink</code></a></td>
      <td><code>0.1.0</code></td>
      <td>Auto-linking library — scanner, Java registry generator, Gradle injector</td>
    </tr>
    <tr>
      <td><a href="./packages/lynx-cli"><code>@kafitra/lynx-cli</code></a></td>
      <td><code>0.2.0</code></td>
      <td>CLI companion — <code>link</code>, <code>run android</code>, <code>prebuild</code>, <code>dev</code>, <code>doctor</code></td>
    </tr>
  </tbody>
</table>

## Monorepo Structure

```
kafitra-lynx-native/
├── packages/                    # Native module libraries
│   ├── lynx-device-info/        # Device info module
│   │   ├── src/                 # TypeScript source
│   │   ├── android/             # Android native implementation
│   │   ├── lynx.module.json     # Auto-link metadata
│   │   └── dist/                # Compiled output
│   ├── lynx-autolink/           # Auto-linking core library
│   │   └── src/                 # scanner, generator, injectors
│   └── lynx-cli/                # CLI (lynx link, run, prebuild, dev, doctor)
│       └── src/
├── apps/                        # Example & demo applications
│   └── demo2/                   # Demo app — device info + hot reload
│       ├── src/                 # App source (App.tsx, App.css)
│       └── android/             # Android host app (generated by lynx prebuild)
└── package.json                 # Root workspace config
```

## Quick Start

### Prerequisites

- **Node.js** >= 18
- **pnpm** >= 8
- **Android Studio** (for native module development)
- **JDK 17+**

### Installation

```bash
# Clone the repository
git clone https://github.com/kafitramarna/kafitra-lynx-native.git
cd kafitra-lynx-native

# Install dependencies
pnpm install

# Build all packages
pnpm run build
```

### Run Demo App

```bash
cd apps/demo2

# First time — generate Android project
npx @kafitra/lynx-cli prebuild --package com.kafitra.demo2

# Connect a device or start an emulator, then:
npx @kafitra/lynx-cli run android
# → installs APK + opens a new terminal with the dev server (hot reload active)
```

> **The demo app** (`apps/demo2`) shows `@kafitra/lynx-device-info` in action — fetches brand, model, manufacturer, OS, API level, and device ID from the native layer and renders them in a card UI.

> **Hot reload** works out-of-the-box via ETag polling: `MainActivity` polls the bundle URL every 1.5 s and calls `renderTemplateUrl` whenever rspeedy rebuilds.

## Using @kafitra/lynx-device-info

### Install

```bash
npm install @kafitra/lynx-device-info
# or
pnpm add @kafitra/lynx-device-info
```

### Android Setup (Auto-linking)

Run the CLI to generate the Java registry and inject Gradle wiring:

```bash
npx @kafitra/lynx-cli link
```

Then in your `Application` class — one line:

```java
// In your Application's initLynxEnv():
LynxEnv.inst().init(this, null, null, null);
LynxAutolinkRegistry.registerAll();
```

> See the [Auto-linking](#auto-linking) section below for full details.

### Usage

```tsx
import { getBrand, getModel, getSDKVersion } from "@kafitra/lynx-device-info";

const brand = await getBrand(); // "Samsung"
const model = await getModel(); // "Galaxy S24"
const sdk = await getSDKVersion(); // 34
```

## Next Development

Here is the list of planned native modules for future development:

<table>
  <thead>
    <tr>
      <th>Module</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>@kafitra/lynx-battery</code></td>
      <td>Battery level, charging status, battery health</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-network</code></td>
      <td>Network type (WiFi/cellular), connection strength, IP address</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-app-info</code></td>
      <td>App version, package name, first install time, build number</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-async-storage</code></td>
      <td>Persistent key-value storage (SharedPreferences)</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-clipboard</code></td>
      <td>Read, write system clipboard</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-file-system</code></td>
      <td>Read, write, delete files on device storage</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-vibration</code></td>
      <td>Haptic feedback and vibration patterns</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-screen</code></td>
      <td>Screen dimensions, orientation, brightness control</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-notifications</code></td>
      <td>Local push notifications</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-permissions</code></td>
      <td>Runtime permission management</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-share</code></td>
      <td>Native share dialog (text, files, URLs)</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-biometrics</code></td>
      <td>Fingerprint and face authentication</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-sensors</code></td>
      <td>Accelerometer, gyroscope, proximity sensor</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-camera</code></td>
      <td>Camera access, photo capture, barcode scanning</td>
    </tr>
    <tr>
      <td><code>@kafitra/lynx-geolocation</code></td>
      <td>GPS location access</td>
    </tr>
  </tbody>
</table>

### Future Considerations

- **iOS Support** — Extend all modules with Swift/ObjC native implementations
- **HarmonyOS Support** — Add ArkTS implementations for Huawei ecosystem
- **Gradle Plugin** — Gradle plugin variant of auto-linking for zero-config build integration
- **Testing Framework** — Shared mock utilities for unit testing native modules

## Auto-linking

Starting with **v0.1.0**, all Kafitra Lynx Native Modules support automatic linking — no manual `registerModule` calls needed.

### How it works

1. Each package ships a `lynx.module.json` metadata file at its root.
2. `@kafitra/lynx-autolink` scans `node_modules` for these files.
3. `@kafitra/lynx-cli link` orchestrates the full process in one command.

### Usage

```bash
# 1. Install a Lynx Native Module
npm install @kafitra/lynx-device-info

# 2. Run the linker (from your Android project root)
npx @kafitra/lynx-cli link

# With a custom android directory name:
npx @kafitra/lynx-cli link --android-dir android-host

# With an explicit Java package (if applicationId can't be inferred):
npx @kafitra/lynx-cli link --java-package com.example.myapp
```

### What `lynx link` does

| Step | Action                                                                             |
| ---- | ---------------------------------------------------------------------------------- |
| 1    | Scans `node_modules` (including hoisted monorepo locations) for `lynx.module.json` |
| 2    | Generates `android/app/src/main/java/<pkg>/LynxAutolinkRegistry.java`              |
| 3    | Injects `include ':module-name'` entries into `android/settings.gradle`            |
| 4    | Injects `implementation project(':module-name')` into `android/app/build.gradle`   |

### Example output

```
→  Scanning for Lynx Native Modules…
ℹ  Found 1 module(s):
ℹ    • @kafitra/lynx-device-info  (LynxDeviceInfo)

→  Generating LynxAutolinkRegistry.java…
✔  Generated: android/app/src/main/java/com/example/app/LynxAutolinkRegistry.java
→  Injecting settings.gradle entries…
✔  Updated: android/settings.gradle
→  Injecting app/build.gradle dependencies…
✔  Updated: android/app/build.gradle

✔ Linking complete

ℹ  In your Application class, call:
ℹ    LynxAutolinkRegistry.registerAll();
```

### Metadata file (`lynx.module.json`)

Place this file at the **root** of each native module package (next to `package.json`):

```json
{
  "name": "LynxDeviceInfo",
  "android": {
    "moduleClass": "com.kafitra.lynxdeviceinfo.LynxDeviceInfoModule",
    "sourceDir": "android"
  }
}
```

| Field                       | Required | Description                                                     |
| --------------------------- | -------- | --------------------------------------------------------------- |
| `name`                      | ✅       | Module name as registered with `LynxEnv`                        |
| `android.moduleClass`       | ✅       | Fully-qualified Java class name                                 |
| `android.sourceDir`         | ✅       | Relative path to the Android library source (e.g. `"android"`)  |
| `android.gradleProjectName` | optional | Override Gradle project name (defaults to kebab-cased npm name) |

### Troubleshooting

| Problem                             | Solution                                                                |
| ----------------------------------- | ----------------------------------------------------------------------- |
| `No Lynx Native Modules found`      | Ensure the package has `lynx.module.json` at its root                   |
| `Could not determine applicationId` | Use `--java-package com.example.app`                                    |
| `build.gradle not found`            | Use `--android-dir` to point to your android folder                     |
| `Malformed lynx.module.json`        | Check for missing `name`, `android.moduleClass`, or `android.sourceDir` |
| Duplicate entries after re-run      | `lynx link` is idempotent — safe to re-run, no duplicates added         |

## Contributing

Contributions are welcome! To add a new native module:

1. Create a new package in `packages/`
2. Follow the structure of `lynx-device-info`
3. Implement TypeScript API + Android native module
4. Add a demo in `apps/demo`
5. Submit a PR

### Development Scripts

```bash
pnpm run build     # Build all packages
pnpm run dev       # Start demo dev server
pnpm run clean     # Clean build artifacts
```

## License

MIT © [Kafitra Marna](https://github.com/kafitramarna)
